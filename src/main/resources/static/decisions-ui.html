<!doctype html>
<html lang='en-GB'>
<head>
  <meta charset='utf-8'>
  <title>Decisions Management</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/omny-0.8.0.css" rel="stylesheet">
  <link href="css/decisions-0.8.0.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/icon/omny-icon-16x16.png" />
</head>
<body>
  <div class="clearfix" id="messages"></div>
  <div class="container" id="container"></div>
  <script id='template' type='text/ractive'>
    <div class="profile pull-right">
      <form name="logoutForm" action="/logout" method="POST">
          <span id="tenantId" class="replaceable super_admin" contenteditable="true" onblur="ractive.switchToTenant($('#tenantId').text())" name="tenantId" value="{{tenant == null ? 'Click to set' : tenant.id}}"></span>
        <span class="profile-img">Logged in as: {{username}}</span>
        <span class="clickable glyphicon glyphicon-log-out" aria-hidden="true" on-click="logout()"></span>
        <input type="hidden" id="_csrf" name="_csrf" value="{{csrfToken}}" />
      </form>
    </div>
    <h1>
      <a class="nav navbar-brand" href="http://omny.link">
      </a>
      <span>Decisions Management</span>
    </h1>
    <div class="clearfix" id="messages">
       <!--<p class=" bg-danger text-danger">Beta! Please ensure you have backups!</p>-->
    </div>

    <section id="decisionsSect">
      <h2>
        <a id="decisionsTableToggle" class="clickable glyphicon glyphicon-triangle-bottom" aria-hidden="true" on-click="toggleResults()" title="Collapse or expand the decision table"></a>
        <span>Decisions</span>
        <a class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="add()" title="Add a new decision"></a>
        <a class="clickable glyphicon glyphicon-refresh" aria-hidden="true" on-click="fetch()" title="Refresh the list"></a>
        <input type="search" class="form-control search" placeholder="Search" value="{{searchTerm}}">
        <a class="glyphicon glyphicon-search" aria-hidden="true" title="Search for matching decisions"></a>
      </h2>
      <table id="decisionsTable" class="table table-striped">
        <thead>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Hit Policy</th>
            <th>Created</th>
            <th>Last Updated</th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
        {{#each decisions:i}}
          {{# (searchTerm!=undefined && matchFilter(this)) }}
              <tr data-href="{{links[rel=='self'].href}}" on-click="select(this)">
                <td>{{i+1}}</td>
                <td>{{name}}</td>
                <td>{{hitPolicy}}</td>
                <td>{{formatDate(created)}}</td>
                <td>{{formatDate(lastUpdated)}}</td>
                <td class="col-actions">
                  <a class="clickable glyphicon glyphicon-pencil" aria-hidden="true" onclick="ractive.select(this);ractive.toggleResults();" title="View or edit this decision"></a>
                </td>
              </tr>
          {{/}}
        {{/each}}
        </tbody>
        <tfoot>
          {{# searchTerm!=undefined }}
            <tr><th colspan="9">{{searchMatched == 0 ? 'No' : searchMatched}} matching decision{{searchMatched==1 ? '' : 's'}}</th></tr>
          {{/}} 
        </tfoot>
      </table>
    </section>

    <section id="dtSect" class="entity-fields" style="display:none">
      <h2>
        <span>Define Decision</span>
        <div class="pull-right">
          <a id="save_as_image" href="#" download="{{decision.name}}.png" target="_blank">
            <span class="glyphicon glyphicon-picture" aria-hidden="true" onclick="ractive.decision2Image();" title="Save image"></span>
          </a>
          <span class="glyphicon glyphicon-export" aria-hidden="true" onclick="ractive.publish(ractive.get('decision'))" title="Publish to Repository"></span>
          <span class="glyphicon glyphicon-remove" aria-hidden="true" onclick="ractive.delete(ractive.get('decision'))" title="Delete"></span>
          <!--<button class="btn" type="button">Validate</button>-->
        </div>
      </h2>
      <table id="decisionTable" class="decision-table table table-striped">
        <thead>
          <tr>
            <th class="decision-name" colspan="3">
              <input title="{{decision.name}}" value="{{decision.name}}"/>
            </th>
          </tr>
        </thead>
        <tbody>
          {{#each decision.conditions:i}}
            <tr class="condition" data-condition="{{name}}">
              <th class="">
                <span class="glyphicon glyphicon-list-alt" aria-hidden="true" style="border:0px"></span>
              </th>
              <th class="expr-name">
                <input autocomplete="false" class="edit typeahead" title="{{name}}" value="{{name}}"/>
              </th>
              <th class="expr-action">
                <span class="clickable glyphicon glyphicon-remove" aria-hidden="true" on-click="deleteCondition(i)"></span>
              </th>
              {{#each expressions:j}}
                <td class="expr"><input title="{{.}}" value="{{.}}"/></td>
              {{/each}}
            {{#if (i==0)}}
              <td class="expr" rowspan="{{decision.conditions[0].expressions.length+decision.conclusions[0].expressions.length+2}}">
                <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="addConditionExpr()"></span>
              </td>
            {{/if}}
            </tr>
          {{/each}}
          <tr class="newCondition">
            <th colspan="2">
              <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="addCondition()"></span>
            </th>
            {{#each decision.conditions[0].expressions}}
              <td>&nbsp;</td>
            {{/each}}
          </tr>
          {{#each decision.conclusions:i}}
            <tr class="conclusion" data-conclusion="{{name}}">
              <th class="">
                <span class="glyphicon glyphicon-flash" aria-hidden="true" style="border:0px"></span>
              </th>
              <th class="expr-name">
                <input autocomplete="false" class="edit typeahead" title="{{name}}" value="{{name}}"/>
              </th>
              <th class="expr-action">
                <span class="clickable glyphicon glyphicon-remove" aria-hidden="true" on-click="deleteConclusion(i)"></span>
              </th>
              {{#each expressions:j}}
                <td class="expr"><input title="{{.}}" value="{{.}}"/></td>
              {{/each}}
            </tr>
          {{/each}}
          <tr class="newConclusion">
            <th colspan="2">
              <span class="clickable glyphicon glyphicon-plus" aria-hidden="true" on-click="addConclusion()"></span>
            </th>
            {{#each decision.conclusions[0].expressions}}
              <td contenteditable>&nbsp;</td>
            {{/each}}
          </tr>
        </tbody>
      </table>

    </section>

  </script>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="js/jquery-1.11.0.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap3-typeahead.js"></script>
  <!--
       If you need IE8 support, change 'ractive' to 'ractive-legacy'.
  -->
  <script src="js/ractive.min.js"></script>
  <!-- <script src='http://cdn.ractivejs.org/latest/ractive.min.js'></script>-->
  <script src="js/md5.min.js"></script>
  <script src="js/canvas2image.js"></script>
  <script src="js/html2canvas.js"></script>
  <script src="js/login-0.8.0.js"></script>
  <script src="js/decisions-0.8.0.js"></script>
  <script src="js/omny-0.8.0.js"></script>
  <script>
    $(document).ready(function() {
      /*var params = getSearchParameters();
      console.log('Params: '+JSON.stringify(params));
      ractive.set('decisionName',
          params['decision'] == undefined ? 'new' : params['decision']);
      */
      if (ractive.tenantCallbacks==undefined) ractive.tenantCallbacks = $.Callbacks();
      ractive.tenantCallbacks.add(function() {
        ractive.fetchDomain();
      });
    });
  </script>

</body>
</html>
